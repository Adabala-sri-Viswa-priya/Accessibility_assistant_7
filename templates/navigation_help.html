{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<div class="chat-container">
    <h2>Navigation Assistant</h2>

    <div id="chat-box"></div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Type your command...">
        <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
        <button id="voice-btn"><i class="fas fa-microphone"></i></button>
    </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const voiceBtn = document.getElementById("voice-btn");

function addMessage(text, sender) {
    const wrapper = document.createElement("div");
    wrapper.classList.add("message-wrapper", sender);

    const avatar = document.createElement("div");
    avatar.classList.add("avatar");
    avatar.innerHTML = sender === "user"
        ? '<i class="fas fa-user"></i>'
        : '<i class="fas fa-robot"></i>';

    const message = document.createElement("div");
    message.classList.add("chat-message");
    message.textContent = text;

    wrapper.appendChild(avatar);
    wrapper.appendChild(message);
    chatBox.appendChild(wrapper);

    chatBox.scrollTop = chatBox.scrollHeight;
}

sendBtn.addEventListener("click", () => {
    const text = userInput.value.trim();
    if (!text) return;

    addMessage(text, "user");
    userInput.value = "";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
        addMessage(data.reply, "assistant");
        if (data.audio) new Audio(data.audio).play();
    });
});

voiceBtn.addEventListener("click", () => {
    if (!("webkitSpeechRecognition" in window)) {
        alert("Voice recognition not supported");
        return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.start();

    recognition.onresult = e => {
        userInput.value = e.results[0][0].transcript;
        sendBtn.click();
    };
});
</script>

<style>
.chat-container {
    max-width: 720px;
    margin: 3rem auto;
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    padding: 2rem;
    display: flex;
    flex-direction: column;
}

.chat-container h2 {
    text-align: center;
    color: #141c5b;
    margin-bottom: 1.5rem;
    font-size: 2.2rem;
}

#chat-box {
    flex: 1;
    height: 420px;
    overflow-y: auto;
    padding: 1rem;
    background: #f5f6fa;
    border-radius: 15px;
}

/* MESSAGE WRAPPER */
.message-wrapper {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.25s ease;
}

.message-wrapper.user {
    justify-content: flex-end;
}

.message-wrapper.assistant {
    justify-content: flex-start;
}

/* AVATAR */
.avatar {
    width: 40px;
    height: 40px;
    background: #141c5b;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 10px;
    font-size: 1.1rem;
}

.message-wrapper.user .avatar {
    order: 2;
    background: #141c5b;
}

.message-wrapper.assistant .avatar {
    background: #141c5b;
}

/* CHAT MESSAGE â€” SAME COLOR FOR BOTH */
.chat-message {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 18px;
    font-size: 1rem;
    line-height: 1.4;
    background: #6671c4;
    color: #ffffff;
}

/* INPUT AREA */
.input-area {
    display: flex;
    gap: 0.6rem;
    margin-top: 1rem;
}

#user-input {
    flex: 1;
    padding: 0.9rem 1.2rem;
    border-radius: 50px;
    border: 1px solid #ccc;
    font-size: 1rem;
    outline: none;
}

#send-btn, #voice-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    background: #141c5b;
    color: white;
    cursor: pointer;
    font-size: 1.1rem;
    transition: 0.3s;
}

#send-btn:hover, #voice-btn:hover {
    background: #1f286f;
}

/* ANIMATION */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== MOBILE ADJUSTMENTS ===== */
@media (max-width: 780px) {
    .chat-container { margin: 1.25rem; padding: 1rem; border-radius:12px; }
    .chat-container h2 { font-size:1.5rem; }
    #chat-box { height: 300px; }
    .message-wrapper .chat-message { max-width: 85%; font-size:0.95rem; }
    .input-area { gap: 8px; }
    #user-input { font-size: 0.98rem; padding: 0.75rem 1rem; }
    #send-btn, #voice-btn { width:44px; height:44px; font-size:1rem; }
    .avatar { width:36px; height:36px; font-size:1rem; }
}
</style>

{% endblock %}